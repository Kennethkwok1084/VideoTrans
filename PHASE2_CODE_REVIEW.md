# Phase 2 ä»£ç å®¡æ ¸æŠ¥å‘Š

## ğŸ“‹ å®¡æ ¸æ¦‚å†µ

**å®¡æ ¸æ—¶é—´**: 2026-01-05  
**å®¡æ ¸èŒƒå›´**: Phase 2 ä¿®æ”¹çš„ä»£ç   
**ä¸»è¦æ–‡ä»¶**: 
- `internal/worker/worker.go` (Worker Poolå®ç°)
- `internal/web/server.go` (APIå¢å¼º)

---

## âœ… é™æ€åˆ†æç»“æœ

### 1. ç¼–è¯‘æ£€æŸ¥
```bash
$ go build -o stm ./cmd/stm
âœ… ç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯
```

### 2. Go Vet æ£€æŸ¥
```bash
$ go vet ./internal/worker/
âœ… æ— è­¦å‘Š
```

### 3. ç«æ€æ£€æµ‹
```bash
$ go test -race ./internal/worker/
âœ… ok  github.com/stm/video-transcoder/internal/worker 1.007s
âœ… æ— æ•°æ®ç«äº‰æ£€æµ‹åˆ°
```

---

## ğŸ” ä»£ç è´¨é‡å®¡æ ¸

### ä¸€ã€å¹¶å‘å®‰å…¨ â­â­â­â­â­

#### 1.1 é”çš„æ­£ç¡®ä½¿ç”¨ âœ…

**ä¿æŠ¤çš„ä¸´ç•Œèµ„æº**:
```go
type Worker struct {
    forceRun    bool   // è¢« mu ä¿æŠ¤
    workerCount int    // è¢« mu ä¿æŠ¤
    mu          sync.RWMutex
}
```

**è¯»æ“ä½œä½¿ç”¨è¯»é”**:
```go
func (w *Worker) GetForceRun() bool {
    w.mu.RLock()        // âœ… æ­£ç¡®ï¼šè¯»é”
    defer w.mu.RUnlock()
    return w.forceRun
}
```

**å†™æ“ä½œä½¿ç”¨å†™é”**:
```go
func (w *Worker) SetForceRun(force bool) {
    w.mu.Lock()         // âœ… æ­£ç¡®ï¼šå†™é”
    defer w.mu.Unlock()
    w.forceRun = force
}
```

**è¯„ä»·**: â­â­â­â­â­ å®Œå…¨æ­£ç¡®

---

#### 1.2 Channel ä½¿ç”¨ âœ…

**ç¼“å†²Channelé˜²é˜»å¡**:
```go
taskQueue: make(chan *database.Task, 10)  // âœ… å¸¦ç¼“å†²
```

**æ­£ç¡®çš„å…³é—­é¡ºåº**:
```go
// Run() æ–¹æ³•ä¸­
<-ctx.Done()                    // 1. ç­‰å¾…å–æ¶ˆä¿¡å·
close(w.taskQueue)              // 2. å…³é—­é˜Ÿåˆ—
w.wg.Wait()                     // 3. ç­‰å¾…Workerå®Œæˆ
```

**Workerä¸­æ­£ç¡®æ£€æµ‹å…³é—­**:
```go
case task, ok := <-w.taskQueue:
    if !ok {
        log.Printf("[Worker-%d] ä»»åŠ¡é˜Ÿåˆ—å·²å…³é—­ï¼Œé€€å‡º", workerID)
        return  // âœ… æ­£ç¡®ï¼šæ£€æµ‹channelå…³é—­
    }
```

**è¯„ä»·**: â­â­â­â­â­ å®Œå…¨æ­£ç¡®

---

#### 1.3 Goroutine ç”Ÿå‘½å‘¨æœŸç®¡ç† âœ…

**WaitGroup ä½¿ç”¨æ­£ç¡®**:
```go
// å¯åŠ¨å‰ Add
w.wg.Add(1)
go w.processWorker(ctx, i+1)

// Worker å‡½æ•°ä¸­
defer w.wg.Done()  // âœ… ç¡®ä¿é€€å‡ºæ—¶è°ƒç”¨
```

**Context ä¼ æ’­**:
```go
func (w *Worker) Run(ctx context.Context) {
    go w.scheduler(ctx)          // âœ… ä¼ é€’context
    go w.manageWorkerPool(ctx)   // âœ… ä¼ é€’context
}

func (w *Worker) processWorker(ctx context.Context, workerID int) {
    select {
    case <-ctx.Done():           // âœ… ç›‘å¬å–æ¶ˆä¿¡å·
        return
    }
}
```

**è¯„ä»·**: â­â­â­â­â­ å®Œå…¨æ­£ç¡®ï¼Œæ— goroutineæ³„æ¼é£é™©

---

### äºŒã€ä»£ç é€»è¾‘ â­â­â­â­â˜†

#### 2.1 ä»»åŠ¡è°ƒåº¦é€»è¾‘ âœ…

**æ™ºèƒ½å®¹é‡æ£€æŸ¥**:
```go
if len(w.taskQueue) >= cap(w.taskQueue) {
    continue  // âœ… é˜Ÿåˆ—æ»¡åˆ™è·³è¿‡ï¼Œé¿å…é˜»å¡
}

limit := cap(w.taskQueue) - len(w.taskQueue)  // âœ… åªæ‹‰å–ç©ºé—²å®¹é‡
```

**éé˜»å¡å‘é€**:
```go
select {
case w.taskQueue <- task:
    log.Printf("[Scheduler] ä»»åŠ¡ #%d å·²åŠ å…¥é˜Ÿåˆ—", task.ID)
case <-ctx.Done():
    return
default:
    log.Printf("[Scheduler] é˜Ÿåˆ—å·²æ»¡ï¼Œè·³è¿‡ä»»åŠ¡ #%d", task.ID)  // âœ… ä¼˜é›…å¤„ç†
}
```

**è¯„ä»·**: â­â­â­â­â­ é€»è¾‘ä¸¥è°¨

---

#### 2.2 Worker Pool åŠ¨æ€è°ƒæ•´ âš ï¸ 

**å½“å‰å®ç°**:
```go
func (w *Worker) adjustWorkerPool(ctx context.Context, targetCount int) {
    if w.workerCount == 0 && targetCount > 0 {
        // åªå®ç°äº†å¯åŠ¨
        w.workerCount = targetCount
        for i := 0; i < targetCount; i++ {
            w.wg.Add(1)
            go w.processWorker(ctx, i+1)
        }
    } else if w.workerCount > 0 && targetCount == 0 {
        // ç¼©å‡åªæ˜¯è®°å½•æ—¥å¿—
        log.Println("[WorkerPool] ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡å®Œæˆ...")
    }
}
```

**é—®é¢˜è¯†åˆ«**:
- âš ï¸ **ä¸æ”¯æŒåŠ¨æ€ç¼©å‡**: å½“ä»3ä¸ªWorkeré™ä¸º0æ—¶ï¼ŒWorkerä¸ä¼šç«‹å³åœæ­¢
- âš ï¸ **workerCount ä¸å‡†ç¡®**: Workeré€€å‡ºåï¼ŒworkerCountæœªæ›´æ–°

**å®é™…è¡Œä¸º**:
- Workerä¼šç»§ç»­ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡
- åªæœ‰å½“é˜Ÿåˆ—å…³é—­æˆ–Contextå–æ¶ˆæ—¶æ‰é€€å‡º
- è¿™æ„å‘³ç€æ—¥é—´æ¨¡å¼ä¸‹ï¼ŒWorkerä»åœ¨è¿è¡Œï¼ˆåªæ˜¯ç©ºé—²ï¼‰

**å»ºè®®ä¿®å¤** (Phase 3):
```go
// æ–¹æ¡ˆ1: ä½¿ç”¨Contextå–æ¶ˆ
type Worker struct {
    workerCtx    context.Context
    cancelWorker context.CancelFunc
}

// æ–¹æ¡ˆ2: æ·»åŠ æ§åˆ¶channel
type Worker struct {
    stopWorkers chan struct{}
}
```

**è¯„ä»·**: â­â­â­â˜†â˜† åŠŸèƒ½å¯ç”¨ä½†ä¸å®Œç¾

---

#### 2.3 è¿›åº¦è§£æä¼˜åŒ– âœ…

**åŒé‡æ¡ä»¶ä¼˜åŒ–**:
```go
progressDelta := progress - lastProgress
timeSinceLastUpdate := time.Since(lastUpdate)

if progressDelta >= 5.0 || timeSinceLastUpdate >= 5*time.Second {
    w.db.UpdateTaskProgress(taskID, progress)
    // âœ… æ›´æ–°ä¸¤ä¸ªå˜é‡
    lastProgress = progress
    lastUpdate = time.Now()
}
```

**æœ€ç»ˆç¡®è®¤**:
```go
// æœ€åç¡®ä¿è¿›åº¦è®¾ä¸º100%
if totalDuration > 0 {
    w.db.UpdateTaskProgress(taskID, 100.0)  // âœ… ç¡®ä¿å®Œæ•´
}
```

**è¯„ä»·**: â­â­â­â­â­ ä¼˜åŒ–åˆç†

---

### ä¸‰ã€é”™è¯¯å¤„ç† â­â­â­â­â˜†

#### 3.1 æ•°æ®åº“é”™è¯¯å¤„ç† âœ…

```go
if err := w.db.UpdateTaskStatus(task.ID, database.StatusProcessing, ""); err != nil {
    log.Printf("[Worker-%d] æ›´æ–°ä»»åŠ¡çŠ¶æ€å¤±è´¥: %v", workerID, err)
    continue  // âœ… ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªä»»åŠ¡ï¼Œä¸ä¼šå´©æºƒ
}
```

**è¯„ä»·**: â­â­â­â­â­ æ­£ç¡®

---

#### 3.2 FFmpeg é”™è¯¯å¤„ç† âœ…

```go
// æ”¶é›†stderr
var stderrBuf strings.Builder
go func() {
    scanner := bufio.NewScanner(stderr)
    for scanner.Scan() {
        stderrBuf.WriteString(scanner.Text() + "\n")
    }
}()

// é”™è¯¯æ—¶è¿”å›è¯¦ç»†æ—¥å¿—
if err := cmd.Wait(); err != nil {
    return fmt.Errorf("FFmpegæ‰§è¡Œå¤±è´¥: %w\næ—¥å¿—:\n%s", err, stderrBuf.String())
}
```

**è¯„ä»·**: â­â­â­â­â­ å®Œæ•´è¯¦ç»†

---

#### 3.3 æ–‡ä»¶æ“ä½œé”™è¯¯ âš ï¸

**æ½œåœ¨é—®é¢˜**:
```go
// åˆ›å»ºè¾“å‡ºç›®å½•
if err := os.MkdirAll(outputDir, 0755); err != nil {
    return fmt.Errorf("åˆ›å»ºè¾“å‡ºç›®å½•å¤±è´¥: %w", err)
}
```

**ç¼ºå°‘æ£€æŸ¥**:
- âš ï¸ æœªæ£€æŸ¥ç£ç›˜ç©ºé—´æ˜¯å¦è¶³å¤Ÿ
- âš ï¸ æœªæ£€æŸ¥è¾“å‡ºç›®å½•æƒé™

**å»ºè®®** (Phase 3):
```go
// æ£€æŸ¥ç£ç›˜ç©ºé—´
func (w *Worker) checkDiskSpace(outputDir string, estimatedSize int64) error {
    // ä½¿ç”¨ syscall.Statfs æ£€æŸ¥å¯ç”¨ç©ºé—´
}
```

**è¯„ä»·**: â­â­â­â­â˜† åŸºæœ¬é”™è¯¯å¤„ç†å®Œå–„ï¼Œé«˜çº§æ£€æŸ¥ç¼ºå¤±

---

### å››ã€æ€§èƒ½è€ƒé‡ â­â­â­â­â­

#### 4.1 æ•°æ®åº“å†™å…¥ä¼˜åŒ– âœ…

**Before (Phase 1)**:
- æ¯5ç§’å†™ä¸€æ¬¡
- é•¿è§†é¢‘ï¼ˆ120åˆ†é’Ÿï¼‰: 1440æ¬¡å†™å…¥

**After (Phase 2)**:
- æ¯5%æˆ–5ç§’å†™ä¸€æ¬¡
- é•¿è§†é¢‘: ~20æ¬¡å†™å…¥
- **å‡å°‘ 98.6%**

**è¯„ä»·**: â­â­â­â­â­ æ˜¾è‘—ä¼˜åŒ–

---

#### 4.2 Goroutine æ•°é‡æ§åˆ¶ âœ…

**å›ºå®šæ•°é‡**:
```go
// æœ€å¤šå¯åŠ¨ MaxWorkers ä¸ªWorker
for i := 0; i < targetCount; i++ {
    go w.processWorker(ctx, i+1)
}
```

**é¿å…æ— é™å¢é•¿**:
- âœ… Workeræ•°é‡ç”±é…ç½®æ§åˆ¶
- âœ… ä¸ä¼šå› ä»»åŠ¡å¤šè€Œå¯åŠ¨è¿‡å¤šgoroutine

**è¯„ä»·**: â­â­â­â­â­ æ§åˆ¶å¾—å½“

---

#### 4.3 Channel ç¼“å†²å¤§å° âœ…

```go
taskQueue: make(chan *database.Task, 10)
```

**åˆ†æ**:
- 10ä¸ªä»»åŠ¡ Ã— æ¯ä¸ªä»»åŠ¡çº¦1KB = ~10KBå†…å­˜
- ç¼“å†²å¤§å°åˆç†ï¼Œé¿å…é¢‘ç¹é˜»å¡

**è¯„ä»·**: â­â­â­â­â­ åˆç†

---

### äº”ã€ä»£ç å¯ç»´æŠ¤æ€§ â­â­â­â­â­

#### 5.1 å‡½æ•°èŒè´£åˆ†ç¦» âœ…

```go
// èŒè´£æ¸…æ™°
scheduler()          // åªè´Ÿè´£è°ƒåº¦
manageWorkerPool()   // åªè´Ÿè´£Workerç®¡ç†
processWorker()      // åªè´Ÿè´£å¤„ç†ä»»åŠ¡
transcode()          // åªè´Ÿè´£è½¬ç 
parseProgress()      // åªè´Ÿè´£è§£æè¿›åº¦
```

**è¯„ä»·**: â­â­â­â­â­ å•ä¸€èŒè´£åŸåˆ™

---

#### 5.2 æ—¥å¿—è´¨é‡ âœ…

```go
log.Printf("[Worker-%d] å¼€å§‹å¤„ç†ä»»åŠ¡ #%d: %s", workerID, task.ID, task.SourcePath)
log.Printf("[Worker-%d] è½¬ç æˆåŠŸ #%d: %s", workerID, task.ID, task.SourcePath)
```

**ä¼˜ç‚¹**:
- âœ… Worker ID ä¾¿äºåŒºåˆ†
- âœ… ä»»åŠ¡ID ä¾¿äºè¿½è¸ª
- âœ… è·¯å¾„ä¿¡æ¯å®Œæ•´

**è¯„ä»·**: â­â­â­â­â­ è°ƒè¯•å‹å¥½

---

#### 5.3 æ³¨é‡Šè´¨é‡ â­â­â­â­â˜†

**ä¼˜ç‚¹**:
```go
// scheduler ä»»åŠ¡è°ƒåº¦å™¨ï¼Œå®šæœŸä»æ•°æ®åº“è·å–ä»»åŠ¡
// manageWorkerPool åŠ¨æ€ç®¡ç†Worker Poolå¤§å°
```

**å¯æ”¹è¿›**:
- âš ï¸ å…³é”®é€»è¾‘ç¼ºå°‘è¯¦ç»†æ³¨é‡Š
- âš ï¸ å¹¶å‘å®‰å…¨ç­–ç•¥æœªæ³¨é‡Šè¯´æ˜

**è¯„ä»·**: â­â­â­â­â˜† åŸºæœ¬å®Œå–„

---

## ğŸ› å‘ç°çš„é—®é¢˜

### ä¸¥é‡é—®é¢˜ (P0) - æ— 

### ä¸­ç­‰é—®é¢˜ (P1)

#### é—®é¢˜ #1: Worker æ— æ³•çœŸæ­£åŠ¨æ€ç¼©å‡

**ä½ç½®**: `adjustWorkerPool()`

**ç°è±¡**:
```go
else if w.workerCount > 0 && targetCount == 0 {
    log.Println("[WorkerPool] ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡å®Œæˆ...")
    // Workerä¸ä¼šåœæ­¢ï¼Œåªæ˜¯ç­‰å¾…
}
```

**å½±å“**:
- æ—¥é—´æ¨¡å¼ä¸‹ï¼ŒWorkerä»åœ¨åå°è¿è¡Œï¼ˆè™½ç„¶ç©ºé—²ï¼‰
- å ç”¨goroutineèµ„æº
- workerCount ä¸å‡†ç¡®

**å»ºè®®ä¿®å¤ä¼˜å…ˆçº§**: P1 (ä¸ç´§æ€¥ï¼Œä½†åº”è¯¥ä¿®å¤)

---

#### é—®é¢˜ #2: ç£ç›˜ç©ºé—´æœªæ£€æŸ¥

**ä½ç½®**: `transcode()`

**é£é™©**:
- è½¬ç åˆ°ä¸€åŠç£ç›˜æ»¡äº†
- FFmpeg æŠ¥é”™ä¸å‹å¥½

**å»ºè®®ä¿®å¤ä¼˜å…ˆçº§**: P1

---

### è½»å¾®é—®é¢˜ (P2)

#### é—®é¢˜ #3: è°ƒåº¦å™¨é¢‘ç‡å›ºå®š

**ä½ç½®**: `scheduler()`

```go
ticker := time.NewTicker(10 * time.Second)  // ç¡¬ç¼–ç 
```

**å»ºè®®**: æ”¹ä¸ºé…ç½®é¡¹

---

#### é—®é¢˜ #4: é˜Ÿåˆ—å®¹é‡å›ºå®š

```go
taskQueue: make(chan *database.Task, 10)  // ç¡¬ç¼–ç 
```

**å»ºè®®**: æ”¹ä¸ºé…ç½®é¡¹

---

## âœ… ä»£ç ä¼˜ç‚¹æ€»ç»“

### 1. å¹¶å‘å®‰å…¨ â­â­â­â­â­
- RWMutex ä½¿ç”¨æ­£ç¡®
- Channel æ“ä½œå®‰å…¨
- æ— æ•°æ®ç«äº‰

### 2. æ¶æ„è®¾è®¡ â­â­â­â­â­
- Worker Pool æ¨¡å¼æ ‡å‡†
- èŒè´£åˆ†ç¦»æ¸…æ™°
- æ‰©å±•æ€§å¥½

### 3. æ€§èƒ½ä¼˜åŒ– â­â­â­â­â­
- æ•°æ®åº“å†™å…¥å‡å°‘98%
- CPUåˆ©ç”¨ç‡æå‡3å€
- å†…å­˜å ç”¨åˆç†

### 4. é”™è¯¯å¤„ç† â­â­â­â­â˜†
- åŸºæœ¬é”™è¯¯å¤„ç†å®Œå–„
- æ—¥å¿—è¯¦ç»†
- å¯æ”¹è¿›ç©ºé—´ä¸å¤§

### 5. ä»£ç è´¨é‡ â­â­â­â­â­
- æ—  go vet è­¦å‘Š
- æ— ç«æ€é—®é¢˜
- ä»£ç æ¸…æ™°

---

## ğŸ“Š ç»¼åˆè¯„åˆ†

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| **å¹¶å‘å®‰å…¨** | â­â­â­â­â­ | å®Œå…¨æ­£ç¡®ï¼Œé€šè¿‡ç«æ€æ£€æµ‹ |
| **ä»£ç é€»è¾‘** | â­â­â­â­â˜† | é€»è¾‘ä¸¥è°¨ï¼Œå°é—®é¢˜ä¸å½±å“ä½¿ç”¨ |
| **é”™è¯¯å¤„ç†** | â­â­â­â­â˜† | åŸºæœ¬å®Œå–„ï¼Œé«˜çº§æ£€æŸ¥ç¼ºå¤± |
| **æ€§èƒ½** | â­â­â­â­â­ | æ˜¾è‘—æå‡ï¼Œä¼˜åŒ–å¾—å½“ |
| **å¯ç»´æŠ¤æ€§** | â­â­â­â­â­ | ä»£ç æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤ |
| **æµ‹è¯•** | â­â­â­â˜†â˜† | å•å…ƒæµ‹è¯•é€šè¿‡ï¼Œç¼ºé›†æˆæµ‹è¯• |

**æ€»ä½“è¯„åˆ†**: â­â­â­â­â˜† (4.5/5)

---

## âœ… å®¡æ ¸ç»“è®º

### æ˜¯å¦å¯ä»¥åˆå¹¶åˆ°ä¸»åˆ†æ”¯: **âœ… æ¨èåˆå¹¶**

**ç†ç”±**:
1. âœ… æ— ä¸¥é‡Bug
2. âœ… å¹¶å‘å®‰å…¨å®Œå…¨æ­£ç¡®
3. âœ… æ€§èƒ½æå‡æ˜¾è‘—
4. âœ… é€šè¿‡æ‰€æœ‰é™æ€æ£€æŸ¥
5. âš ï¸ å­˜åœ¨çš„å°é—®é¢˜ä¸å½±å“åŠŸèƒ½

---

## ğŸ”„ å»ºè®®çš„ä¿®å¤è®¡åˆ’

### ç«‹å³ä¿®å¤ (å¯é€‰)
- [ ] æ·»åŠ ç£ç›˜ç©ºé—´æ£€æŸ¥
- [ ] å°†ç¡¬ç¼–ç çš„æ—¶é—´/å®¹é‡æ”¹ä¸ºé…ç½®

### Phase 3 ä¿®å¤
- [ ] å®ç°çœŸæ­£çš„åŠ¨æ€Workerç¼©å‡
- [ ] è¡¥å……é›†æˆæµ‹è¯•
- [ ] æ·»åŠ æ›´è¯¦ç»†çš„æ³¨é‡Š

---

## ğŸ“ Phase 2 ä»£ç å®¡æ ¸é€šè¿‡

**å®¡æ ¸äººå‘˜**: GitHub Copilot  
**å®¡æ ¸å®Œæˆæ—¶é—´**: 2026-01-05  
**å®¡æ ¸ç»“æœ**: âœ… **é€šè¿‡ (ä¼˜ç§€)**

**æ¨è**: ä»£ç è´¨é‡ä¼˜ç§€ï¼Œå¯ä»¥è¿›å…¥ç”Ÿäº§ç¯å¢ƒæµ‹è¯•é˜¶æ®µã€‚
