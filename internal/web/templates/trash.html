<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åƒåœ¾æ¡¶ - STM è§†é¢‘è½¬ç æœåŠ¡</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- å¯¼èˆªæ  -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900">ğŸ“¹ STM è½¬ç æœåŠ¡</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="px-4 py-2 text-gray-600 hover:text-gray-900">ä»ªè¡¨ç›˜</a>
                    <a href="/tasks" class="px-4 py-2 text-gray-600 hover:text-gray-900">ä»»åŠ¡åˆ—è¡¨</a>
                    <a href="/trash" class="px-4 py-2 text-blue-600 font-semibold border-b-2 border-blue-600">åƒåœ¾æ¡¶</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- è­¦å‘Šæç¤º -->
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <span class="text-2xl">âš ï¸</span>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-700">
                        åƒåœ¾æ¡¶ä¸­çš„æ–‡ä»¶å°†åœ¨ <strong>30 å¤©åè‡ªåŠ¨æ°¸ä¹…åˆ é™¤</strong>ã€‚åˆ é™¤æ“ä½œä¸å¯æ’¤é”€ï¼Œè¯·è°¨æ…æ“ä½œã€‚
                    </p>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">åƒåœ¾æ¡¶ç»Ÿè®¡</h2>
                    <p class="text-sm text-gray-600 mt-1">
                        å…± <span id="fileCount" class="font-medium">0</span> ä¸ªæ–‡ä»¶ï¼Œ
                        å ç”¨ <span id="totalSize" class="font-medium">0 MB</span>
                    </p>
                </div>
                <button onclick="emptyTrash()"
                    class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">
                    æ¸…ç©ºåƒåœ¾æ¡¶
                </button>
            </div>
        </div>

        <!-- æ–‡ä»¶åˆ—è¡¨ -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            æ–‡ä»¶å
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            å¤§å°
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            åˆ é™¤æ—¶é—´
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            å‰©ä½™æ—¶é—´
                        </th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            æ“ä½œ
                        </th>
                    </tr>
                </thead>
                <tbody id="trashTableBody" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                            åŠ è½½ä¸­...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- åˆ é™¤ç¡®è®¤å¯¹è¯æ¡† -->
    <div id="deleteModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <span class="text-2xl">ğŸ—‘ï¸</span>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">ç¡®è®¤åˆ é™¤</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">
                        ç¡®å®šè¦æ°¸ä¹…åˆ é™¤ <strong id="deleteFileName"></strong> å—ï¼Ÿ
                    </p>
                    <p class="text-xs text-red-600 mt-2">
                        æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼
                    </p>
                </div>
                <div class="flex gap-4 mt-4">
                    <button onclick="closeDeleteModal()"
                        class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition">
                        å–æ¶ˆ
                    </button>
                    <button onclick="confirmDelete()"
                        class="flex-1 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">
                        ç¡®è®¤åˆ é™¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let deleteTarget = null;

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // è®¡ç®—å‰©ä½™å¤©æ•°
        function calculateDaysLeft(deleteTime) {
            if (!deleteTime) return '-';
            const deleteDate = new Date(deleteTime);
            const deleteDeadline = new Date(deleteDate.getTime() + 30 * 24 * 60 * 60 * 1000);
            const now = new Date();
            const daysLeft = Math.ceil((deleteDeadline - now) / (1000 * 60 * 60 * 24));

            if (daysLeft < 0) return 'å³å°†åˆ é™¤';
            if (daysLeft === 0) return 'ä»Šå¤©';
            if (daysLeft === 1) return 'æ˜å¤©';
            return `${daysLeft} å¤©`;
        }

        // è·å–å‰©ä½™å¤©æ•°çš„é¢œè‰²
        function getDaysLeftColor(deleteTime) {
            if (!deleteTime) return 'text-gray-600';
            const deleteDate = new Date(deleteTime);
            const deleteDeadline = new Date(deleteDate.getTime() + 30 * 24 * 60 * 60 * 1000);
            const now = new Date();
            const daysLeft = Math.ceil((deleteDeadline - now) / (1000 * 60 * 60 * 24));

            if (daysLeft <= 3) return 'text-red-600 font-semibold';
            if (daysLeft <= 7) return 'text-yellow-600 font-medium';
            return 'text-gray-600';
        }

        // åŠ è½½åƒåœ¾æ¡¶æ–‡ä»¶åˆ—è¡¨
        async function loadTrashFiles() {
            try {
                const res = await fetch('/api/trash');
                const data = await res.json();

                const tbody = document.getElementById('trashTableBody');
                const fileCountEl = document.getElementById('fileCount');
                const totalSizeEl = document.getElementById('totalSize');

                fileCountEl.textContent = data.files?.length || 0;
                totalSizeEl.textContent = formatSize(data.total_size || 0);

                if (!data.files || data.files.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                                åƒåœ¾æ¡¶ä¸ºç©º
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = data.files.map(file => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-gray-900 max-w-md truncate" title="${file.name}">
                                ${file.name}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                            ${formatSize(file.size)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                            ${formatTime(file.delete_time)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${getDaysLeftColor(file.delete_time)}">
                            ${calculateDaysLeft(file.delete_time)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="showDeleteModal('${file.name}')" 
                                    class="text-red-600 hover:text-red-900">
                                æ°¸ä¹…åˆ é™¤
                            </button>
                        </td>
                    </tr>
                `).join('');

            } catch (err) {
                console.error('åŠ è½½åƒåœ¾æ¡¶å¤±è´¥:', err);
            }
        }

        // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
        function showDeleteModal(filename) {
            deleteTarget = filename;
            document.getElementById('deleteFileName').textContent = filename;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        // å…³é—­åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
        function closeDeleteModal() {
            deleteTarget = null;
            document.getElementById('deleteModal').classList.add('hidden');
        }

        // ç¡®è®¤åˆ é™¤
        async function confirmDelete() {
            if (!deleteTarget) return;

            try {
                const res = await fetch(`/api/trash/${encodeURIComponent(deleteTarget)}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    alert('æ–‡ä»¶å·²æ°¸ä¹…åˆ é™¤');
                    loadTrashFiles();
                } else {
                    const data = await res.json();
                    alert('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (err) {
                alert('åˆ é™¤å¤±è´¥: ' + err.message);
            } finally {
                closeDeleteModal();
            }
        }

        // æ¸…ç©ºåƒåœ¾æ¡¶
        async function emptyTrash() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºåƒåœ¾æ¡¶å—ï¼Ÿæ‰€æœ‰æ–‡ä»¶å°†è¢«æ°¸ä¹…åˆ é™¤ï¼Œæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) return;
            if (!confirm('æœ€åç¡®è®¤ï¼šçœŸçš„è¦åˆ é™¤åƒåœ¾æ¡¶ä¸­çš„æ‰€æœ‰æ–‡ä»¶å—ï¼Ÿ')) return;

            try {
                // TODO: å®ç°æ‰¹é‡åˆ é™¤ API
                alert('åŠŸèƒ½å¼€å‘ä¸­...');
            } catch (err) {
                alert('æ¸…ç©ºå¤±è´¥: ' + err.message);
            }
        }

        // åˆå§‹åŒ–
        loadTrashFiles();

        // å®šæœŸåˆ·æ–°ï¼ˆæ¯ 30 ç§’ï¼‰
        setInterval(loadTrashFiles, 30000);
    </script>
</body>

</html>