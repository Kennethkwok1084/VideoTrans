<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»åŠ¡åˆ—è¡¨ - STM è§†é¢‘è½¬ç æœåŠ¡</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- å¯¼èˆªæ  -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900">ğŸ“¹ STM è½¬ç æœåŠ¡</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="px-4 py-2 text-gray-600 hover:text-gray-900">ä»ªè¡¨ç›˜</a>
                    <a href="/tasks" class="px-4 py-2 text-blue-600 font-semibold border-b-2 border-blue-600">ä»»åŠ¡åˆ—è¡¨</a>
                    <a href="/trash" class="px-4 py-2 text-gray-600 hover:text-gray-900">åƒåœ¾æ¡¶</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- ç­›é€‰å™¨ -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex space-x-2">
                    <button onclick="filterTasks('all')" id="btnAll" class="filter-btn active">
                        å…¨éƒ¨
                    </button>
                    <button onclick="filterTasks('pending')" id="btnPending" class="filter-btn">
                        å¾…å¤„ç†
                    </button>
                    <button onclick="filterTasks('processing')" id="btnProcessing" class="filter-btn">
                        å¤„ç†ä¸­
                    </button>
                    <button onclick="filterTasks('completed')" id="btnCompleted" class="filter-btn">
                        å·²å®Œæˆ
                    </button>
                    <button onclick="filterTasks('failed')" id="btnFailed" class="filter-btn">
                        å¤±è´¥
                    </button>
                    <button onclick="filterTasks('scan_error')" id="btnScanError" class="filter-btn">
                        æ‰«æå¼‚å¸¸
                    </button>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="btnRetryFailed" onclick="retryFailed()"
                        class="hidden px-3 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition">
                        ä¸€é”®é‡è¯•å¤±è´¥
                    </button>
                    <button id="btnRetryProcessing" onclick="retryProcessing()"
                        class="hidden px-3 py-2 text-sm font-medium text-white bg-orange-600 rounded-md hover:bg-orange-700 transition">
                        æ¢å¤æœªå®Œæˆ
                    </button>
                    <div class="text-sm text-gray-600">
                        å…± <span id="totalCount">0</span> ä¸ªä»»åŠ¡
                    </div>
                </div>
            </div>
        </div>

        <!-- ä»»åŠ¡è¡¨æ ¼ -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            æ–‡ä»¶å
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            çŠ¶æ€
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            è¿›åº¦
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            å¤§å°å˜åŒ–
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            åˆ›å»ºæ—¶é—´
                        </th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            æ“ä½œ
                        </th>
                    </tr>
                </thead>
                <tbody id="taskTableBody" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                            åŠ è½½ä¸­...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- åˆ†é¡µ -->
        <div class="mt-6 flex items-center justify-between">
            <button id="btnPrev" onclick="prevPage()"
                class="px-4 py-2 bg-white border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                ä¸Šä¸€é¡µ
            </button>
            <div class="text-sm text-gray-700">
                ç¬¬ <span id="currentPage">1</span> é¡µ
            </div>
            <button id="btnNext" onclick="nextPage()"
                class="px-4 py-2 bg-white border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                ä¸‹ä¸€é¡µ
            </button>
        </div>
    </main>

    <style>
        .filter-btn {
            @apply px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition;
        }

        .filter-btn.active {
            @apply bg-blue-600 text-white border-blue-600 hover:bg-blue-700;
        }
    </style>

    <script>
        let currentFilter = 'all';
        let currentPage = 1;
        const pageSize = 20;
        const retryFailedBtn = document.getElementById('btnRetryFailed');
        const retryProcessingBtn = document.getElementById('btnRetryProcessing');

        // è·å–çŠ¶æ€å¾½ç«  HTML
        function getStatusBadge(status) {
            const badges = {
                'pending': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">å¾…å¤„ç†</span>',
                'processing': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">å¤„ç†ä¸­</span>',
                'completed': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">å·²å®Œæˆ</span>',
                'failed': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">å¤±è´¥</span>'
            };
            return badges[status] || status;
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getLogText(task) {
            if (!task || !task.log) return '';
            if (typeof task.log === 'string') return task.log;
            if (task.log.Valid) return task.log.String || '';
            return '';
        }

        function formatLogSnippet(text, maxLen) {
            if (!text) return '';
            if (text.length <= maxLen) return text;
            return text.slice(0, maxLen) + '...';
        }

        function escapeHtml(value) {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // åŠ è½½ä»»åŠ¡åˆ—è¡¨
        async function loadTasks() {
            try {
                const filter = currentFilter === 'all' ? '' : currentFilter;
                const res = await fetch(`/api/tasks?status=${filter}&page=${currentPage}&limit=${pageSize}`);
                const tasks = await res.json();

                const tbody = document.getElementById('taskTableBody');

                if (tasks.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                                æš‚æ— ä»»åŠ¡
                            </td>
                        </tr>
                    `;
                    document.getElementById('btnNext').disabled = true;
                    return;
                }

                tbody.innerHTML = tasks.map(task => {
                    const savedBytes = task.source_size - task.output_size;
                    const savedPercent = task.source_size > 0
                        ? ((savedBytes / task.source_size) * 100).toFixed(1)
                        : 0;
                    const logText = getLogText(task);
                    const logSnippet = formatLogSnippet(logText, 120);
                    const errorText = logSnippet || 'æœªçŸ¥é”™è¯¯';
                    const errorTitle = logText || errorText;
                    const showScanError = currentFilter === 'scan_error' && logText;

                    return `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4">
                                <div class="text-sm font-medium text-gray-900 max-w-md truncate" title="${task.source_path}">
                                    ${task.source_path.split('/').pop()}
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    ${task.source_path}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                ${getStatusBadge(task.status)}
                                ${task.status === 'failed'
                            ? `<div class="text-xs text-red-600 mt-1" title="${escapeHtml(errorTitle)}">${escapeHtml(errorText)}</div>`
                            : ''}
                                ${showScanError
                            ? `<div class="text-xs text-orange-600 mt-1" title="${escapeHtml(errorTitle)}">${escapeHtml(errorText)}</div>`
                            : ''}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                ${task.status === 'processing'
                            ? `<div class="w-full bg-gray-200 rounded-full h-2">
                                         <div class="bg-blue-600 h-2 rounded-full" style="width: ${task.progress}%"></div>
                                       </div>
                                       <span class="text-xs text-gray-600 mt-1">${task.progress}%</span>`
                            : '-'}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                ${task.source_size > 0
                            ? `<div class="text-sm text-gray-900">
                                         ${formatSize(task.source_size)} â†’ ${formatSize(task.output_size)}
                                       </div>
                                       <div class="text-xs text-green-600">
                                         èŠ‚çœ ${savedPercent}%
                                       </div>`
                            : '-'}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${formatTime(task.created_at)}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                ${task.status === 'failed'
                            ? `<button onclick="retryTask(${task.id})" class="text-blue-600 hover:text-blue-900 mr-3">é‡è¯•</button>`
                            : ''}
                                <button onclick="deleteTask(${task.id})" class="text-red-600 hover:text-red-900">åˆ é™¤</button>
                            </td>
                        </tr>
                    `;
                }).join('');

                // æ›´æ–°åˆ†é¡µæŒ‰é’®
                document.getElementById('btnPrev').disabled = currentPage === 1;
                document.getElementById('btnNext').disabled = tasks.length < pageSize;
                document.getElementById('currentPage').textContent = currentPage;

            } catch (err) {
                console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', err);
            }
        }

        // ç­›é€‰ä»»åŠ¡
        function filterTasks(status) {
            currentFilter = status;
            currentPage = 1;

            // æ›´æ–°æŒ‰é’®æ ·å¼
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const btnMap = {
                'all': 'btnAll',
                'pending': 'btnPending',
                'processing': 'btnProcessing',
                'completed': 'btnCompleted',
                'failed': 'btnFailed',
                'scan_error': 'btnScanError'
            };
            const btnId = btnMap[status] || 'btnAll';
            const targetBtn = document.getElementById(btnId);
            if (targetBtn) {
                targetBtn.classList.add('active');
            }

            updateFilterActions();
            loadTasks();
        }

        // ä¸Šä¸€é¡µ
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                loadTasks();
            }
        }

        // ä¸‹ä¸€é¡µ
        function nextPage() {
            currentPage++;
            loadTasks();
        }

        // é‡è¯•ä»»åŠ¡
        async function retryTask(id) {
            if (!confirm('ç¡®å®šè¦é‡è¯•æ­¤ä»»åŠ¡å—ï¼Ÿ')) return;

            try {
                await fetch(`/api/tasks/${id}/retry`, { method: 'POST' });
                alert('ä»»åŠ¡å·²é‡æ–°åŠ å…¥é˜Ÿåˆ—');
                loadTasks();
            } catch (err) {
                alert('é‡è¯•å¤±è´¥: ' + err.message);
            }
        }

        // ä¸€é”®é‡è¯•å¤±è´¥ä»»åŠ¡
        async function retryFailed() {
            if (!confirm('ç¡®å®šè¦é‡è¯•å…¨éƒ¨å¤±è´¥ä»»åŠ¡å—ï¼Ÿ')) return;

            try {
                const res = await fetch('/api/tasks/retry-failed', { method: 'POST' });
                const data = await res.json();
                const count = data.count || 0;
                alert(`å·²é‡è¯• ${count} ä¸ªå¤±è´¥ä»»åŠ¡`);
                loadTasks();
            } catch (err) {
                alert('é‡è¯•å¤±è´¥: ' + err.message);
            }
        }

        // æ¢å¤æœªå®Œæˆä»»åŠ¡
        async function retryProcessing() {
            if (!confirm('ç¡®å®šè¦æ¢å¤æ‰€æœ‰æœªå®Œæˆä»»åŠ¡å—ï¼Ÿ')) return;

            try {
                const res = await fetch('/api/tasks/retry-processing', { method: 'POST' });
                const data = await res.json();
                const count = data.count || 0;
                alert(`å·²æ¢å¤ ${count} ä¸ªæœªå®Œæˆä»»åŠ¡`);
                loadTasks();
            } catch (err) {
                alert('æ¢å¤å¤±è´¥: ' + err.message);
            }
        }

        function updateFilterActions() {
            if (retryFailedBtn) {
                if (currentFilter === 'failed') {
                    retryFailedBtn.classList.remove('hidden');
                } else {
                    retryFailedBtn.classList.add('hidden');
                }
            }
            if (retryProcessingBtn) {
                if (currentFilter === 'processing') {
                    retryProcessingBtn.classList.remove('hidden');
                } else {
                    retryProcessingBtn.classList.add('hidden');
                }
            }
        }

        // åˆ é™¤ä»»åŠ¡
        async function deleteTask(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ä»»åŠ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;

            try {
                await fetch(`/api/tasks/${id}`, { method: 'DELETE' });
                alert('ä»»åŠ¡å·²åˆ é™¤');
                loadTasks();
            } catch (err) {
                alert('åˆ é™¤å¤±è´¥: ' + err.message);
            }
        }

        // åˆå§‹åŒ–
        loadTasks();
        updateFilterActions();

        // å®šæœŸåˆ·æ–°ï¼ˆæ¯ 10 ç§’ï¼‰
        setInterval(loadTasks, 10000);
    </script>
</body>

</html>
